# Debugging Log

This document tracks minor bug fixes, debugging sessions, and small corrections that don't warrant full entries in `develop_plan.md` / `develop_summary.md`. Entries are in reverse chronological order (newest first).

Format: `[date] issue → cause → fix (files touched)`

---

## 2026-02-02

- **Init pose moves too fast** — Calling `/teleop/init_pose` service instantly sets ctrl values and steps physics 100x, causing the robot to teleport to the target pose. Dangerous for real robot. → Changed to smooth cosine interpolation over 1000 physics steps (~2s at 500Hz). Captures current ctrl as start, interpolates to target with `0.5*(1-cos(π*α))` easing. (`teleop_system/simulators/mujoco_ros2_bridge.py`)

- **Arm teleop URDF not found when run via `ros2 launch`** — `arm_teleop_node.py` uses `Path(__file__).parent⁴` to locate `models/rby1/urdf/model_pinocchio.urdf`, which resolves to `site-packages/` in installed mode instead of the source tree. Also, `setup.py` doesn't include `models/` directory in `data_files`. → Added 3-tier path resolution: (1) `ament_index_python.get_package_share_directory`, (2) `__file__` parent traversal, (3) CWD fallback. Also added `models/rby1/urdf/*.urdf` and `models/rby1/*.xml` to `setup.py` `data_files`. (`teleop_system/modules/arm_teleop/arm_teleop_node.py`, `setup.py`)

- **Tracker View is 2D (X-Z / Y-Z projections)** — GUI tracker view used DearPyGui plot scatter/line series showing 2D projections, which lacked depth perception compared to matplotlib's 3D viewer. → Replaced with DearPyGui drawlist canvases using isometric 3D projection (elev=25°, azim=-60°). Both panels (skeleton + tracker) now show 3D perspective with ground grid, axis markers, and depth-aware rendering. Added `project_3d_to_2d()`, `_draw_tracker_3d()`, and `BONE_CATEGORY` mapping. (`teleop_system/gui/control_panel.py`)

- **Head tracker position hardcoded to [0, 0, 1.55] in GUI** — `gui_node.py` `_hmd_cb` always set head position to `[0, 0, 1.55]` because HMD only provides orientation. When BVH replay publishes actual head position, it was overwritten by the HMD callback. → (1) Added `TRACKER_HEAD = "/master/tracker/head"` to TopicNames, (2) Added HEAD to BVH replay `_tracker_pubs`, (3) Added head tracker subscription in gui_node.py alongside other trackers, (4) Changed `_hmd_cb` to only set fallback position if no tracker data exists for head. (`teleop_system/utils/ros2_helpers.py`, `teleop_system/mocap/bvh_replay_publisher.py`, `teleop_system/gui/gui_node.py`)

- **E-stop/soft-stop doesn't stop robot movement** — GUI publishes zeros at 50Hz on e-stop, but arm_teleop_node publishes IK solutions at 100Hz on the same topics. MuJoCo bridge applies the latest message, so arm teleop's higher rate overrides the zeros. → Added `/system/estop_active` Bool topic. GUI publishes True on e-stop/soft-stop, False on release/resume. MuJoCo bridge subscribes and ignores all command callbacks when estop is active, also zeroes all ctrl immediately. (`teleop_system/utils/ros2_helpers.py`, `teleop_system/simulators/mujoco_ros2_bridge.py`, `teleop_system/gui/gui_node.py`)

---

## 2026-02-01

- **Emergency Stop only fires once** — Clicking "EMERGENCY STOP" in the GUI published zero commands once, but arm_teleop immediately overwrote them with new IK commands on the next cycle (~10ms later). → Changed E-stop to a toggle: when activated, a 50Hz timer continuously publishes zero commands on all arm/hand/base command topics until released. Also zeroes hand commands (was arm+base only). Button changes to bright red with "RELEASE E-STOP" label when active. (`teleop_system/gui/control_panel.py`, `teleop_system/gui/gui_node.py`)

- **Module Status indicators never change from gray** — The ModuleStatus objects had `connected`/`enabled` fields but nothing in gui_node.py ever set them. Status indicators always showed gray (disconnected). → Replaced static connected/enabled model with activity-based tracking: each module has a `last_activity` timestamp updated when any of its ROS2 topics receive data. GUI shows green (<2s), yellow (<10s), orange (>10s), or gray (never received). Added subscriptions: hand input topics, base cmd_vel (locomotion monitoring). (`teleop_system/gui/control_panel.py`, `teleop_system/gui/gui_node.py`)

- **GUI window too small for most displays** — Default 1000x700 window with 1.0-1.2x font scale was unreadable on 1080p+ screens. → Increased base window to 1800x1000, raised minimum auto-scale to 2.0x (was 1.0x). Scale factors: 4K→3.0x, 1440p→2.5x, 1080p→2.0x. (`teleop_system/gui/control_panel.py`, `docs/user_guide.md`)

- **Master launch viewer only supports ROS2 mode (no TCP for cross-machine)** — `launch_viewer:=true` in `master_sim.launch.py` / `master_mocap.launch.py` always launched `--mode ros2-viewer`, which subscribes to ROS2 camera topics. For cross-machine operation, the viewer needs TCP client mode to receive from the slave's streaming server. → Added `viewer_mode` (default: `ros2-viewer`), `viewer_host` (default: `localhost`), `viewer_port` (default: `9876`) launch arguments. When `viewer_mode:=client`, the viewer connects via TCP. Also added "Viewer (TCP)" button + host/port inputs to the GUI control panel, and `--viewer-mode`/`--viewer-host`/`--viewer-port` flags to Python scripts. (`launch/master_sim.launch.py`, `launch/master_mocap.launch.py`, `teleop_system/gui/control_panel.py`, `teleop_system/gui/gui_node.py`, `scripts/launch_master.py`, `scripts/launch_master_mocap.py`, `docs/user_guide.md`)

- **GUI exit code -6 persists after error-message fix** — Even after improving error messages for missing Dear PyGui, the `gui_control_panel` node still crashed with `terminate called without an active exception` (SIGABRT, exit code -6). Root cause: the ROS2 executor spin thread (`threading.Thread(target=executor.spin, daemon=True)`) was still joinable when `rclpy.shutdown()` was called. The C++ `std::thread` destructor calls `std::terminate()` on a joinable thread. → Added `spin_thread.join(timeout=3.0)` after `executor.shutdown()` in both the error path (DPG not available) and normal shutdown path. (`teleop_system/gui/gui_node.py`)

- **BVH replay starts immediately — no initial pose alignment** — Running `master_mocap.launch.py` caused BVH motion data to play instantly, with no time for the robot to align to the initial pose. → Implemented staged playback: added `auto_start` parameter (default: `false`) to `bvh_replay_publisher.py`. When `auto_start=false`, all tracker/hand adapters are paused at frame 0 (READY state), publishing the initial pose repeatedly. Call `/teleop/start_playback` service or press "Start Playback" in the GUI to begin advancing (PLAYING state). Added `pause()`/`resume()` to `BVHHandAdapter` (tracker adapter already had them). Added playback state topic `/playback/state` (JSON: `{state, progress}`) at 2Hz. (`teleop_system/mocap/bvh_replay_publisher.py`, `teleop_system/mocap/bvh_hand_adapter.py`, `teleop_system/gui/control_panel.py`, `teleop_system/gui/gui_node.py`, `teleop_system/utils/ros2_helpers.py`, `launch/master_mocap.launch.py`, `scripts/launch_master_mocap.py`, `docs/user_guide.md`)

- **`camera_fps` parameter type mismatch (INTEGER vs DOUBLE)** — `declare_parameter("camera_fps", 15.0)` locks type to DOUBLE. Passing `camera_fps:=30` from launch CLI is parsed as INTEGER by ROS2, causing `ParameterTypeException`. → Added `ParameterDescriptor(dynamic_typing=True)` to all numeric/bool params in `mujoco_ros2_bridge.py` so ROS2 accepts int/double/string interchangeably. Existing `_get_float_param`/`_get_int_param`/`_get_bool_param` helpers handle conversion. Also updated docs to use `30.0` in examples. (`teleop_system/simulators/mujoco_ros2_bridge.py`, `launch/slave_mujoco.launch.py`, `docs/user_guide.md`)

- **GUI node exit code -6 when Dear PyGui not installed** — `gui_control_panel` node crashed with SIGABRT when `dearpygui` was not installed. → Improved error messages to include install command (`pip install dearpygui>=2.1.1`), fixed executor shutdown order in error path. (`teleop_system/gui/gui_node.py`, `teleop_system/gui/control_panel.py`)

- **MuJoCo model not found in colcon install tree** — Running with `colcon build` (without `--symlink-install`) puts `__file__` inside `ros2_ws/install/...`, so `Path(__file__).parent.parent.parent` doesn't reach the source root where `models/` lives. → Added CWD fallback path resolution and improved error message suggesting `--symlink-install`. (`teleop_system/simulators/mujoco_ros2_bridge.py`)

- **matplotlib version requirement too low** — `setup.py` specified `matplotlib>=3.6.0` but matplotlib < 3.9.0 is incompatible with NumPy 2.x (crashes in `mpl_toolkits`). → Updated to `matplotlib>=3.9.0` in both `mocap` and `all` extras, updated `user_guide.md` Section 10.1. (`setup.py`, `docs/user_guide.md`)

- **`run_mocap_replay.py --view` NumPy 2.x crash in matplotlib** — System apt matplotlib 3.6.3 (`/usr/lib/python3/dist-packages/`) was compiled against NumPy 1.x; incompatible with pip NumPy 2.3.5. Also `mpl_toolkits` from system path shadowed pip version, breaking Axes3D → Installed pip matplotlib 3.10.8 (`pip install --break-system-packages --force-reinstall --ignore-installed 'matplotlib>=3.9.0'`), renamed system `mpl_toolkits` and `.pth` file to `.bak` (no code change)

- **`run_mocap_replay.py` / `run_parameter_sweep.py` ModuleNotFoundError: teleop_system** — Running `python3 scripts/run_mocap_replay.py` adds `scripts/` to `sys.path`, not the project root. `from teleop_system.mocap...` fails since the package is in the parent directory → Added `sys.path.insert(0, project_root)` at top of both scripts (`scripts/run_mocap_replay.py`, `scripts/run_parameter_sweep.py`)
